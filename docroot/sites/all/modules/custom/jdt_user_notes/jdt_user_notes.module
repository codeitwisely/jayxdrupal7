<?php
/**
 * @file
 * jdt_user_notes.module
 * This file includes hooks for permissions and other.
 */

/**
 * Implements hook_permission().
 */
function jdt_user_notes_permission() {
  return array(
    'view user notes' => array(
      'title' => t('View any user note'),
      'description' => t('View any published user notes.'),
    ),
    'add user notes' => array(
      'title' => t('Create new user note'),
      'description' => t('Add user notes.'),
    ),
    'edit own user notes' => array(
      'title' => t('Edit own user note'),
      'description' => t('Edit own user notes.'),
    ),
    'edit any user notes' => array(
      'title' => t('Edit any user note'),
      'description' => t('Edit any user notes.'),
    ),
    'delete own user notes' => array(
      'title' => t('Delete own user note'),
      'description' => t('Delete own user notes.'),
    ),
    'delete any user notes' => array(
      'title' => t('Delete any user note'),
      'description' => t('Delete any user notes.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function jdt_user_notes_menu() {
  $items['jdt-user-notes/%_jdt_user_notes_note/view'] = array(
    'title' => 'View a note',
    'page callback' => '_jdt_user_notes_note_view',
    'page arguments' => array(1),
    'access arguments' => array('view user notes'),
    'type' => MENU_CALLBACK,
  );
  $items['jdt-user-notes/%node/add'] = array(
    'title' => 'Add new note to an article',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_jdt_user_notes_note_form', 1),
    'access arguments' => array('add user notes'),
    'type' => MENU_CALLBACK,
  );
  $items['jdt-user-notes/%_jdt_user_notes_note/edit'] = array(
    'title' => 'Edit a note',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_jdt_user_notes_note_form', 1),
    'access arguments' => array(1, 'edit own user notes', 'edit any user notes'),
    'access callback' => '_jdt_user_notes_access_callback',
    'type' => MENU_CALLBACK,
  );
  $items['jdt-user-notes/%_jdt_user_notes_note/delete'] = array(
    'title' => 'Delete a note',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_jdt_user_notes_delete_form', 1),
    'access arguments' => array(1, 'delete own user notes', 'delete any user notes'),
    'access callback' => '_jdt_user_notes_access_callback',
    'type' => MENU_CALLBACK,
  );
  $items['node/%node/notes'] = array(
    'title' => 'My Notes',
    'description' => 'Display notes related to an article',
    'page callback' => '_jdt_user_notes_display_notes',
    'page arguments' => array(1),
    'access callback' => '_jdt_user_notes_get_notes',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
  );
  $items['jdt-user-notes/%ctools_js'] = array(
    'page callback' => 'jdt_user_notes_callback',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['modal/page'] = array(
    'page callback' => 'jdt_user_notes_page',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Function to manage access permission to notes.
 *
 * @param $object_loaded
 *   The object loaded on the page can be a note or a node.
 * @param $permission
 *   The global permission such as edit own notes.
 * @param $super_permission
 *   The super permission such as edit any notes.
 * @return
 *   True or false.
 */
function _jdt_user_notes_access_callback($object_loaded, $permission, $super_permission) {
  if (user_access($super_permission)) {
    return TRUE;
  }

  $user_id = _jdt_user_notes_get_current_user_id();
  // Object is a note.
  if (isset($object_loaded->author_uid)) {
    if ($object_loaded->author_uid == $user_id && user_access($permission)) {
      return TRUE;
    }
  }

  // Object is a node.
  if ($object_loaded->uid == $user_id && user_access($permission)) {
    return TRUE;
  }

  return FALSE;
}

/**
 * Loader for getting notes in object format for a given note_id.
 *
 * @param $note_id
 *   The note_id to load.
 * @return
 *   Return result in object format.
 */
function _jdt_user_notes_note_load($note_id) {
  module_load_include('inc', 'jdt_user_notes', 'jdt_user_notes.crud');
  return _jdt_user_notes_select_note($note_id);
}

/**
 * Custom function to add or edit a user note .
 *
 * @param $form
 *   The add note form.
 * @param $form_state
 *   The form elements available.
 * @param $object_loaded
 *   The object that we pass can be a note or a node.
 * @return
 *   The add note form for an article which nid is passed on the url.
 */
function _jdt_user_notes_note_form($form, &$form_state, $object_loaded) {
  $form['article_nid']['#type'] = 'value';
  $form['author_uid']['#type'] = 'value';
  $form['note_id']['#type'] = 'value';
  $form['note_text'] = array(
    '#type' => 'textarea',
    '#title' => t('Note text'),
    '#cols' => 60  ,
    '#rows' => 5,
    '#required' => TRUE,
  );
  dpm($form);
  if (isset($object_loaded->nid)) {
    $form['article_nid']['#value'] = $object_loaded->nid;
    $form['author_uid']['#value'] = _jdt_user_notes_get_current_user_id();
  }
  else {
    $form['note_id']['#value'] = $object_loaded->note_id;
    $form['article_nid']['#value'] = $object_loaded->article_nid;
    $form['author_uid']['#value'] = $object_loaded->author_uid;
    $form['note_text']['#default_value'] = $object_loaded->note_text;
  }
  // Now I add also a button.
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save note'),
  );
  return $form;
}

/**
 * Add the data to be insert or updated on the jdt user notes table.
 *
 * @param $form
 *   The add note form.
 * @param $form_state
 *   The form elements available.
 */
function _jdt_user_notes_note_form_submit($form, &$form_state) {
  module_load_include('inc', 'jdt_user_notes', 'jdt_user_notes.crud');
  $values =  $form_state['values'];
  $entry = array(
    'article_nid' => $values['article_nid'],
    'author_uid' => $values['author_uid'],
    'note_text' => $values['note_text']
  );
  if (!$values['note_id']) {
    $create = _jdt_user_notes_create_note($entry);
    $message = t('The note has been added');
  }
  else {
    $entry['note_id'] = $values['note_id'];
    $update = _jdt_user_notes_updt_note($entry);
    $message = t('The note has been updated');
  }
  $form_state['redirect'] = '<front>';
  drupal_set_message(check_plain($message), 'status');
}

/**
 * We display the note_text field for a given note object passed in parameter.
 *
 * @param $note
 *   The note object.
 * @return
 *   The note_text field for the note_id passed in the url.
 */
function _jdt_user_notes_note_view($note) {
  $select = _jdt_user_notes_select_note($note->note_id);
  $header = array(t('Note text'));
  $row[] = array($select->note_text);
  $output = theme('table', array('header' => $header, 'rows' => $row));
  $output .= l(t('Edit Note'), 'jdt-user-notes/' . $note->note_id . '/edit');

  return $output;
}

/**
 * Return the form to delete a note which id is passed in the url.
 *
 * @param $form
 *   The delete note form.
 * @param $form_state
 *   The form elements available.
 * @param $note
 *   The note object.
 * @return
 *   Return the delete form form a note.
 */
function _jdt_user_notes_delete_form($form, &$form_state, $note) {
  $form['#item'] = $note;
  $form['header'] = array(
    '#markup' => t('Are you sure you wish to delete the note with the note_id %value ?', array('%value' => $note->note_id)),
    '#prefix' => '<h2>',
    '#suffix' => '</h2>',
  );
  $form['warning'] = array(
    '#markup' => t('Warning, this action cannot be undone'),
    '#prefix' => '<p>',
    '#suffix' => '</p>',
  );
  $form['delete_button'] = array(
    '#type' => 'submit',
    '#value' => t('Delete note'),
  );
  return $form;
}

/**
 * This function is the handler on delete form submission.
 *
 * @param $form
 *   The delete note form.
 * @param $form_state
 *   The note form elements available.
 */
function _jdt_user_notes_delete_form_submit($form, &$form_state) {
  if ($form_state['values']['op'] == $form_state['values']['delete_button']) {
    $note = $form['#item'];
    $note_id = $note->note_id;
    module_load_include('inc', 'jdt_user_notes', 'jdt_user_notes.crud');
    _jdt_user_notes_del_note($note_id);
  }
  $form_state['redirect'] = '<front>';
  drupal_set_message(t('The note has been deleted'));
}

/**
 * Get the uid of the current user.
 *
 * @return
 *   Current user uid.
 */
function _jdt_user_notes_get_current_user_id() {
  global $user;
  $user_id = $user->uid;
  return $user_id;
}

/**
 * Task 21.
 * Task 21.
 */

/**
 * Implements hook_theme().
 */
function jdt_user_notes_theme() {
  return array(
  // Placeholders to hold initial values.
    'jdt_user_notes' => array(
      'variables' => array(
        'notes' => FALSE,
        'node_title' => FALSE,
        'node_author' => FALSE,
        'node' => FALSE,
        'edit' => FALSE,
      ),
      'template' => 'theme/jdt-user-notes',
    ),
  );
}

/**
 * Function to display notes for an article.
 *
 * @param $node
 * The node object for which we want to display notes.
 * @return
 *   An array with the node object passed.
 */
function _jdt_user_notes_display_notes($node) {
  return array(
    '#theme' => 'jdt_user_notes',
    '#node' => $node,
  );
}

/**
 * We Create a tab for notes only if notes exist for a given article.
 *
 * @param $node
 * The node object that we want to get.
 * @return
 *   Return true if there is notes for an article or false.
 */
function _jdt_user_notes_get_notes($node) {
  module_load_include('inc', 'jdt_user_notes', 'jdt_user_notes.crud');
  return _jdt_user_notes_article_notes($node->nid);
}

/**
 * Implements template_preprocess_THEMEHOOK().
 */
function template_preprocess_jdt_user_notes(&$variables) {
  $node = $variables['node'];
  $variables['node_title'] = $node->title;
  $variables['node_author'] = $node->name;
  $variables['notes'] = _jdt_user_notes_article_notes($node->nid);
  $variables['edit'] = _jdt_user_notes_make_link($link_text = '');
}

/**
 * Task 24
 */

/**
 * Helper function to make a link.
 */
function _jdt_user_notes_make_link($link_text = '') {
  ctools_include('modal');
  ctools_modal_add_js();
  // Set a default value if no text in supplied.
  if (empty($link_text)) {
    $link_text = 'Edit note';
  }
  return ' ' . l($link_text, 'jdt-user-notes/nojs', array('attributes' => array('class' => 'ctools-use-modal'))) . ' ';
}

/**
 * An example page.
 */
function jdt_user_notes_page() {
  // Load the modal library and add the modal javascript.
  ctools_include('modal');
  ctools_modal_add_js();
  return _jdt_user_notes_make_link('Magical modal');
}

/**
 * Ajax menu callback.
 */
function jdt_user_notes_callback($ajax) {
  if ($ajax) {
    ctools_include('ajax');
    ctools_include('modal');
    $form_state = array(
      'ajax' => TRUE,
      'title' => t('MyModule Modal Form'),
    );
    // Use ctools to generate ajax instructions for the browser to create
    // a form in a modal popup.
    $output = ctools_modal_form_wrapper('_jdt_user_notes_note_form', $form_state, $object_loaded);
    // If the form has been submitted, there may be additional instructions
    // such as dismissing the modal popup.
    if (!empty($form_state['ajax_commands'])) {
      $output = $form_state['ajax_commands'];
    }
    // Return the ajax instructions to the browser via ajax_render().
    print ajax_render($output);
    drupal_exit();
  }
  else {
    return drupal_get_form('_jdt_user_notes_note_form');
  }
}

/**
 * Drupal form to be put in a modal.
 */
function jdt_user_notes_form($form, $form_state) {
  $form = array();
  $form['new_link_text'] = array(
    '#type' => 'textfield',
    '#title' => t('Link text'),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );
  return $form;
}

/**
 * Drupal form submit handler.
 */
function jdt_user_notes_form_submit(&$form, &$form_state) {
  // Generate the new link using the submitted text value.
  $link = _jdt_user_notes_make_link($form_state['values']['new_link_text']);
  // Tell the browser to close the modal.
  $form_state['ajax_commands'][] = ctools_modal_command_dismiss();
  // Tell the browser to replace the old link with the new one.
  $form_state['ajax_commands'][] = ajax_command_replace('#magical-modal-link', $link);

}
