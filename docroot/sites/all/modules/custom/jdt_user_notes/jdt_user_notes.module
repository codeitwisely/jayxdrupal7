<?php
/**
 * @file
 * jdt_user_notes.module
 * This file includes hooks for permissions and other.
 */

// We include the crud file in order to use some available functions.
// To make requests to the database.
module_load_include('inc', 'jdt_user_notes', 'jdt_user_notes.crud');

/**
 * Implements hook_permission().
 * @return
 *   Array of permissions.
 */
function jdt_user_notes_permission() {
  return array(
    'view user notes' => array(
      'title' => t('View any user note'),
      'description' => t('View any published user notes.'),
    ),
    'add user notes' => array(
      'title' => t('Create new user note'),
      'description' => t('Add user notes.'),
    ),
    'edit own user notes' => array(
      'title' => t('Edit own user note'),
      'description' => t('Edit own user notes.'),
    ),
    'edit any user notes' => array(
      'title' => t('Edit any user note'),
      'description' => t('Edit any user notes.'),
    ),
    'delete own user notes' => array(
      'title' => t('Delete own user note'),
      'description' => t('Delete own user notes.'),
    ),
    'delete any user notes' => array(
      'title' => t('Delete any user note'),
      'description' => t('Delete any user notes.'),
    ),
  );
}

/**
 * Implements hook_menu().
 * @return
 *   Array of items.
 */
function jdt_user_notes_menu() {
  $items['jdt-user-notes/%jdt_user_notes/view'] = array(
    'title' => 'View',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_jdt_user_notes_note_view', 1),
    'access arguments' => array('view user notes'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['jdt-user-notes/%node/add'] = array(
    'title' => 'Add new note to an article',
    'page callback' => 'drupal_get_form',
    'access arguments' => array('add user notes'),
    'page arguments' => array('_jdt_user_notes_add_form', 1),
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['jdt-user-notes/%jdt_user_notes/edit'] = array(
    'title' => 'Edit',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_jdt_user_notes_edit_form', 1),
    'access arguments' => array('edit own user notes'),
    'type' => MENU_LOCAL_TASK,
  );
  $items['jdt-user-notes/%jdt_user_notes/delete'] = array(
    'title' => 'Delete',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_jdt_user_notes_delete_form', 1),
    'access arguments' => array('delete own user notes'),
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

/**
 * Custom function to add a new user note to the database.
 * @param $form
 *   The add note form.
 * @param $form_state
 *   The form elements available.
 * @param $node
 *   The object node to get the nid passed in the url.
 * @return
 *   The add note form for an article which nid is passed on the url.
 */
function _jdt_user_notes_add_form($form, &$form_state, $node) {
  $form['#item'] = $node;
  $node_id = $node->nid;
  $user_id = _jdt_user_notes_get_current_user_id();
  $form['article_nid'] = array(
    '#type' => 'value',
    '#value' => $node_id,
  );
  $form['author_uid'] = array(
    '#type' => 'value',
    '#value' => $user_id,
  );
  $form['note_text'] = array(
      '#type' => 'textarea',
      '#title' => 'Note text',
      '#cols' => 60  ,
      '#rows' => 5,
      '#maxlength' => 100,
      '#required' => TRUE,
  );
  // now I add also a button
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Add user note'),
  );
  $form['#submit'][] = '_jdt_user_notes_add_form_submit_handler';
  return $form;
}

/**
 * Add the data to be insert on the table.
 * @param $form
 *   The add note form.
 * @param $form_state
 *   The form elements available.
 */
function _jdt_user_notes_add_form_submit_handler($form, &$form_state) {
  $node = $form['#item'];
  $article_nid = $node->nid;
  $author_uid = $form_state['values']['author_uid'];
  $note_text = $form_state['values']['note_text'];
  $entry = array(
    'article_nid' => $article_nid,
    'author_uid' => $author_uid,
    'note_text' => $note_text
  );
  if (isset($node->nid) && $node->nid) {
    $create = _jdt_user_notes_create_note($entry);
  }
  $form_state['redirect'] = '<front>';
  drupal_set_message(t('The note has been added'), 'status');
}

/**
 * Return the note_text for a note.
 * @param $form
 *   The view form.
 * @param $form_state
 *   The form elemenets available.
 * @param $note
 *   The note object.
 * @return
 *   The note_text field for the note_id passed in the url.
 */
function _jdt_user_notes_note_view($form, &$form_state, $note) {
  $note_id = $note->note_id;
  $select = _jdt_user_notes_note_select($note_id);
  $form['note_text'] = array(
    '#type' => 'textfield',
    '#title' => t('Note'),
    '#disabled' => TRUE,
    '#default_value' => $select['note_text'],
  );
  return $form;
}

/**
 * Return the note edit form.
 * @param $form
 *   The edit note form.
 * @param $form_state
 *   The form elements available.
 * @param $note
 *   The note object.
 * @return
 *   The note edit form.
 */
function _jdt_user_notes_edit_form($form, &$form_state, $note) {
  $user_id = _jdt_user_notes_get_current_user_id();
  $form['#item'] = $note;
  $article_id = $note->article_nid;
  $default_value_note = _jdt_user_notes_note_exists($article_id, $user_id);
  $default_note_id = _jdt_user_notes_note_id($article_id, $user_id);
  $form['note_text'] = array(
    '#type' => 'textfield',
    '#title' => t('Note'),
    '#required' => TRUE,
    '#default_value' => $default_value_note,
  );
  // Grab value for node id and make it part of the form state.
  // so you can use it later.
  $form['article_nid'] = array(
    '#type' => 'value',
    '#value' => $note->article_nid,
  );
  // Make User ID available to the form.
  $form['author_uid'] = array(
    '#type' => 'value',
    '#value' => $note->author_uid,
  );
  // Make note ID available to the form.
  $form['note_id'] = array(
    '#type' => 'value',
    '#value' => $default_note_id,
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save Note'),
  );
  $form['#submit'][] = '_jdt_user_notes_edit_form_submit_handler';
  return $form;
}

/**
 * This is the submit handler for the edting of a note which id is passed on URL.
 * @param $form
 *   The editng note form.
 * @param $form_state
 *   The form elements available.
 */
function _jdt_user_notes_edit_form_submit_handler($form, &$form_state) {
  $note = $form['#item'];
  $note_id = $note->note_id;
  $article_nid = $form_state['values']['article_nid'];
  $author_uid = $form_state['values']['author_uid'];
  $note_text = $form_state['values']['note_text'];
  $entry = array(
    'note_id' => $note_id,
    'article_nid' => $article_nid,
    'author_uid' => $author_uid,
    'note_text' => $note_text
  );
  if (isset($note_id) && $note_id) {
    $update = _jdt_user_notes_updt_note($entry);
    if ($update == 1 ) {
      $form_state['redirect'] = '<front>';
      drupal_set_message(t('The note has been updated'), 'status');
    }
    else {
      drupal_set_message(t('The note can\'t be updated'), 'error');
    }
  }
}

/**
 * Return the form to delete a note which id is passed in the url.
 * @param $form
 *   The delete note form.
 * @param $form_state
 *   The form elements available.
 * @param $note
 *   The note object.
 * @return
 *   Return the delete form form a note.
 */
function _jdt_user_notes_delete_form($form, &$form_state, $note) {
  $form['#item'] = $note;
  $form['header'] = array(
    '#markup' => t('Are you sure you wish to delete the note with the note_id <em>@value</em>?', array('@value' => $note->note_id)),
    '#prefix' => '<h2>',
    '#suffix' => '</h2>',
  );
  $form['warning'] = array(
    '#markup' => t('Warning, this action cannot be undone'),
    '#prefix' => '<p>',
    '#suffix' => '</p>',
  );
  $form['delete_button'] = array(
    '#type' => 'submit',
    '#value' => t('Delete note'),
  );
  return $form;
}

/**
 * This function is the handler on delete form submission.
 * @param $form
 *   The delete note form.
 * @param $form_state
 *   The note form elements available.
 */
function _jdt_user_notes_delete_form_submit($form, &$form_state) {
  if ($form_state['values']['op'] == $form_state['values']['delete_button']) {
    $note = $form['#item'];
    $note_id = $note->note_id;
    _jdt_user_notes_del_note($note_id);
  }
  $form_state['redirect'] = '<front>';
  drupal_set_message(t('The item has been deleted'));
}

/**
 * Get the uid of the current user.
 * @return
 *   Current user uid.
 */
function _jdt_user_notes_get_current_user_id() {
  global $user;
  $user_id = $user->uid;

  return $user_id;
}
